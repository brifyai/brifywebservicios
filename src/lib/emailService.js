// Servicio de email para envÃ­o de correos de bienvenida
// Usando Gmail API directamente con tokens almacenados

class EmailService {
  constructor() {
    this.accessToken = null
    this.refreshToken = null
    this.isInitialized = false
  }

  // Obtener tokens almacenados desde Supabase
  async getStoredTokens() {
    try {
      const { createClient } = await import('@supabase/supabase-js')
      const supabase = createClient(
        process.env.REACT_APP_SUPABASE_URL,
        process.env.REACT_APP_SUPABASE_ANON_KEY
      )
      
      const { data, error } = await supabase
        .from('user_credentials')
        .select('google_access_token, google_refresh_token')
        .eq('user_id', 'admin') // Asumiendo que el admin tiene ID 'admin'
        .single()
      
      if (error) {
        console.error('Error obteniendo tokens:', error)
        return null
      }
      
      return {
        accessToken: data.google_access_token,
        refreshToken: data.google_refresh_token
      }
    } catch (error) {
      console.error('Error conectando a Supabase:', error)
      return null
    }
  }

  // Inicializar Gmail API
  async init() {
    try {
      if (this.isInitialized) {
        return true
      }

      // Cargar Google API
      await this.loadGoogleAPI()
      
      // Inicializar Gmail API
      await window.gapi.load('client', async () => {
        await window.gapi.client.init({
          apiKey: process.env.REACT_APP_GOOGLE_API_KEY,
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
        })
      })

      // Verificar si hay autenticaciÃ³n activa
      if (window.gapi && window.gapi.auth2) {
        const authInstance = window.gapi.auth2.getAuthInstance()
        if (authInstance && authInstance.isSignedIn.get()) {
          const user = authInstance.currentUser.get()
          const authResponse = user.getAuthResponse()
          this.accessToken = authResponse.access_token
          this.isInitialized = true
          return true
        }
      }

      // Si no hay autenticaciÃ³n activa, intentar usar tokens almacenados
      const storedTokens = await this.getStoredTokens()
      if (storedTokens && storedTokens.accessToken) {
        this.accessToken = storedTokens.accessToken
        this.refreshToken = storedTokens.refreshToken
        this.isInitialized = true
        return true
      }

      console.warn('No se encontraron tokens vÃ¡lidos para Gmail API')
      return false
    } catch (error) {
      console.error('Error inicializando Gmail API:', error)
      throw error
    }
  }

  // Cargar Google API dinÃ¡micamente
  async loadGoogleAPI() {
    return new Promise((resolve, reject) => {
      if (window.gapi) {
        resolve()
        return
      }

      const script = document.createElement('script')
      script.src = 'https://apis.google.com/js/api.js'
      script.onload = () => resolve()
      script.onerror = () => reject(new Error('Failed to load Google API'))
      document.head.appendChild(script)
    })
  }

  // Enviar correo de bienvenida
  async sendWelcomeEmail(clientEmail, clientName) {
    try {
      const initialized = await this.init()
      if (!initialized) {
        throw new Error('No se pudo inicializar Gmail API')
      }

      // Configurar el token de acceso
      if (this.accessToken) {
        window.gapi.client.setToken({
          access_token: this.accessToken
        })
      } else {
        throw new Error('No se encontrÃ³ un token de acceso vÃ¡lido')
      }
      
      const subject = `Â¡Bienvenido a Brify, ${clientName}!`
      const message = this.getWelcomeMessage(clientName)
      
      // Crear el mensaje en formato RFC 2822
      const email = [
        `To: ${clientEmail}`,
        `Subject: ${subject}`,
        'Content-Type: text/plain; charset=utf-8',
        '',
        message
      ].join('\n')
      
      // Codificar en base64url
      const encodedMessage = btoa(email)
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '')
      
      const response = await window.gapi.client.gmail.users.messages.send({
        userId: 'me',
        resource: {
          raw: encodedMessage
        }
      })

      console.log('Email enviado exitosamente:', response)
      return { success: true, messageId: response.result.id }
    } catch (error) {
      console.error('Error enviando email de bienvenida:', error)
      return { success: false, error: error.message }
    }
  }

  // Generar mensaje de bienvenida personalizado
  getWelcomeMessage(clientName) {
    return `
Â¡Hola ${clientName}! ðŸŽ‰

Â¡Te damos la bienvenida a Brify! ðŸš€

Te invitamos a que agregues a tu plataforma Telegram nuestro bot '@brifybeta_bot' ðŸ¤–

Â¡AquÃ­ podrÃ¡s preguntar y ver todo el contenido que tiene tu entrenador disponible para ti! ðŸ’ª

âœ¨ Â¿QuÃ© puedes hacer con nuestro bot?
â€¢ Hacer preguntas sobre tu entrenamiento
â€¢ Acceder a contenido personalizado
â€¢ Recibir consejos de tu entrenador
â€¢ Y mucho mÃ¡s...

ðŸ”— Para comenzar, simplemente:
1. Abre Telegram
2. Busca: @brifybeta_bot
3. Inicia una conversaciÃ³n
4. Â¡Disfruta de tu experiencia personalizada!

Â¡Esperamos que disfrutes de todo lo que tenemos preparado para ti! ðŸŒŸ

Saludos,
El equipo de Brify ðŸ’™
    `.trim()
  }

  // MÃ©todo alternativo usando fetch para APIs de email como SendGrid, Mailgun, etc.
  async sendEmailWithAPI(clientEmail, clientName) {
    try {
      // Este es un ejemplo usando una API genÃ©rica
      // Puedes reemplazarlo con SendGrid, Mailgun, etc.
      const response = await fetch('/api/send-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          to: clientEmail,
          subject: 'Â¡Bienvenido a Brify! ðŸŽ‰ Agrega nuestro bot de Telegram',
          html: this.getWelcomeEmailHTML(clientName)
        })
      })

      if (!response.ok) {
        throw new Error('Error en la respuesta del servidor')
      }

      const result = await response.json()
      return { success: true, result }
    } catch (error) {
      console.error('Error enviando email con API:', error)
      return { success: false, error: error.message }
    }
  }

  // Template HTML para el correo
  getWelcomeEmailHTML(clientName) {
    return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â¡Bienvenido a Brify!</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
        .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
        .telegram-section { background: #0088cc; color: white; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .steps { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #667eea; }
        .footer { text-align: center; margin-top: 30px; color: #666; }
        .emoji { font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">ðŸŽ‰</span> Â¡Bienvenido a Brify, ${clientName}! <span class="emoji">ðŸŽ‰</span></h1>
            <p>Tu plataforma de entrenamiento personalizado</p>
        </div>
        
        <div class="content">
            <p><span class="emoji">ðŸš€</span> Â¡Estamos emocionados de tenerte con nosotros!</p>
            
            <div class="telegram-section">
                <h2><span class="emoji">ðŸ¤–</span> Â¡Conecta con nuestro Bot de Telegram!</h2>
                <p><strong>@brifybeta_bot</strong></p>
                <p>AquÃ­ podrÃ¡s preguntar y ver todo el contenido que tiene tu entrenador disponible para ti</p>
            </div>
            
            <div class="steps">
                <h3><span class="emoji">âœ¨</span> Â¿QuÃ© puedes hacer con nuestro bot?</h3>
                <div class="step"><span class="emoji">ðŸ’¬</span> Hacer preguntas sobre tu entrenamiento</div>
                <div class="step"><span class="emoji">ðŸ“š</span> Acceder a contenido personalizado</div>
                <div class="step"><span class="emoji">ðŸ’¡</span> Recibir consejos de tu entrenador</div>
                <div class="step"><span class="emoji">ðŸŽ¯</span> Y mucho mÃ¡s...</div>
            </div>
            
            <div class="steps">
                <h3><span class="emoji">ðŸ”—</span> Para comenzar, simplemente:</h3>
                <div class="step">1. Abre Telegram</div>
                <div class="step">2. Busca: <strong>@brifybeta_bot</strong></div>
                <div class="step">3. Inicia una conversaciÃ³n</div>
                <div class="step">4. <span class="emoji">ðŸŒŸ</span> Â¡Disfruta de tu experiencia personalizada!</div>
            </div>
            
            <p><span class="emoji">ðŸ’ª</span> Â¡Esperamos que disfrutes de todo lo que tenemos preparado para ti!</p>
        </div>
        
        <div class="footer">
            <p>Saludos,<br><strong>El equipo de Brify</strong> <span class="emoji">ðŸ’™</span></p>
        </div>
    </div>
</body>
</html>
    `.trim()
  }
}

// Crear instancia singleton
const emailService = new EmailService()

export default emailService

// Exportar tambiÃ©n la clase para casos especÃ­ficos
export { EmailService }